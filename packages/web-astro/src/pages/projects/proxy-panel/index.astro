---
import Layout from "../../../layouts/Layout.astro";

const defaultUrl =
    "https://cors-www.lilnong.top/static/html/img-resize-merge-upload-config.html";
const iframeUrls = {
    queryUrl: `/projects/iframe/?url=${encodeURIComponent(defaultUrl)}`,
    pathUrl: `/projects/iframe/${encodeURIComponent(defaultUrl)}`,
    hashUrl: `/projects/iframe/#${encodeURIComponent(defaultUrl)}`,
};
const serverProxyUrls = {
    queryUrl: `/projects/astro-server-proxy/?url=${encodeURIComponent(defaultUrl)}`,
    pathUrl: `/projects/astro-server-proxy/${encodeURIComponent(defaultUrl)}`,
    hashUrl: `/projects/astro-server-proxy/#${encodeURIComponent(defaultUrl)}`,
};
---

<Layout title="代理面板 - Home 2025">
    <div
        class="min-h-screen bg-gradient-to-b from-gray-50 to-white dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <div class="space-y-4">
                <!-- 标题和返回按钮 -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <a
                            href="/projects"
                            class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </a>
                        <h1
                            class="text-2xl font-bold text-gray-900 dark:text-white"
                        >
                            代理面板
                        </h1>
                    </div>
                </div>

                <!-- URL 展示区域 -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-4"
                >
                    <h2
                        class="text-lg font-semibold text-gray-900 dark:text-white"
                    >
                        测试 URL
                    </h2>
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <span
                                class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24"
                                >原始 URL：</span
                            >
                            <code
                                class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1"
                                >{defaultUrl}</code
                            >
                        </div>
                        <div class="flex items-center space-x-2">
                            <span
                                class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24"
                                >Query 形式：</span
                            >
                            <code
                                class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1"
                                >{iframeUrls.queryUrl}</code
                            >
                        </div>
                        <div class="flex items-center space-x-2">
                            <span
                                class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24"
                                >Path 形式：</span
                            >
                            <code
                                class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1"
                                >{iframeUrls.pathUrl}</code
                            >
                        </div>
                        <div class="flex items-center space-x-2">
                            <span
                                class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24"
                                >Hash 形式：</span
                            >
                            <code
                                class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1"
                                >{iframeUrls.hashUrl}</code
                            >
                        </div>
                    </div>
                </div>

                <!-- iframe 展示区域 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- iframe 代理 - Query 形式 -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden"
                    >
                        <div
                            class="p-4 border-b border-gray-200 dark:border-gray-700"
                        >
                            <h3
                                class="text-lg font-semibold text-gray-900 dark:text-white"
                            >
                                iframe 代理 - Query
                            </h3>
                        </div>
                        <div class="relative" style="height: 300px;">
                            <iframe
                                src={iframeUrls.queryUrl}
                                class="absolute inset-0 w-full h-full"
                                loading="lazy"></iframe>
                        </div>
                    </div>

                    <!-- iframe 代理 - Path 形式 -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden"
                    >
                        <div
                            class="p-4 border-b border-gray-200 dark:border-gray-700"
                        >
                            <h3
                                class="text-lg font-semibold text-gray-900 dark:text-white"
                            >
                                iframe 代理 - Path
                            </h3>
                        </div>
                        <div class="relative" style="height: 300px;">
                            <iframe
                                src={iframeUrls.pathUrl}
                                class="absolute inset-0 w-full h-full"
                                loading="lazy"></iframe>
                        </div>
                    </div>

                    <!-- iframe 代理 - Hash 形式 -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden"
                    >
                        <div
                            class="p-4 border-b border-gray-200 dark:border-gray-700"
                        >
                            <h3
                                class="text-lg font-semibold text-gray-900 dark:text-white"
                            >
                                iframe 代理 - Hash
                            </h3>
                        </div>
                        <div class="relative" style="height: 300px;">
                            <iframe
                                src={iframeUrls.hashUrl}
                                class="absolute inset-0 w-full h-full"
                                loading="lazy"></iframe>
                        </div>
                    </div>

                    <!-- 服务器代理 - Query 形式 -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden"
                    >
                        <div
                            class="p-4 border-b border-gray-200 dark:border-gray-700"
                        >
                            <h3
                                class="text-lg font-semibold text-gray-900 dark:text-white"
                            >
                                服务器代理 - Query
                            </h3>
                        </div>
                        <div class="relative" style="height: 300px;">
                            <iframe
                                src={serverProxyUrls.queryUrl}
                                class="absolute inset-0 w-full h-full"
                                loading="lazy"></iframe>
                        </div>
                    </div>

                    <!-- 服务器代理 - Path 形式 -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden"
                    >
                        <div
                            class="p-4 border-b border-gray-200 dark:border-gray-700"
                        >
                            <h3
                                class="text-lg font-semibold text-gray-900 dark:text-white"
                            >
                                服务器代理 - Path
                            </h3>
                        </div>
                        <div class="relative" style="height: 300px;">
                            <iframe
                                src={serverProxyUrls.pathUrl}
                                class="absolute inset-0 w-full h-full"
                                loading="lazy"></iframe>
                        </div>
                    </div>

                    <!-- 服务器代理 - Hash 形式 -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden"
                    >
                        <div
                            class="p-4 border-b border-gray-200 dark:border-gray-700"
                        >
                            <h3
                                class="text-lg font-semibold text-gray-900 dark:text-white"
                            >
                                服务器代理 - Hash
                            </h3>
                        </div>
                        <div class="relative" style="height: 300px;">
                            <iframe
                                src={serverProxyUrls.hashUrl}
                                class="absolute inset-0 w-full h-full"
                                loading="lazy"></iframe>
                        </div>
                    </div>
                </div>

                <!-- URL 测试工具 -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2
                        class="text-lg font-semibold text-gray-900 dark:text-white mb-4"
                    >
                        URL 测试工具
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label
                                for="test-url"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                            >
                                输入要测试的 URL
                            </label>
                            <input
                                type="url"
                                id="test-url"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"
                                placeholder="https://example.com"
                            />
                        </div>
                        <div class="flex space-x-4">
                            <button
                                id="generate-urls"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                生成 URL
                            </button>
                            <button
                                id="copy-urls"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600"
                            >
                                复制所有 URL
                            </button>
                        </div>
                        <div id="generated-urls" class="space-y-2 hidden">
                            <!-- 生成的 URL 将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    const STORAGE_KEY = "proxy-panel-url";

    // 初始化页面
    document.addEventListener("DOMContentLoaded", () => {
        // 从 localStorage 获取保存的 URL
        const savedUrl = localStorage.getItem(STORAGE_KEY);

        // 如果有保存的 URL，更新页面上的 URL 显示和 iframe
        if (savedUrl) {
            // 更新 URL 输入框
            const input = document.getElementById(
                "test-url",
            ) as HTMLInputElement;
            if (input) {
                input.value = savedUrl;
            }

            // 更新 URL 展示区域
            const urls = generateUrls(savedUrl);
            updateGeneratedUrls(urls);

            // 更新原始 URL 显示
            const originalUrlCode = document.querySelector(
                ".flex-1.text-sm.bg-gray-100.dark\\:bg-gray-700.rounded.px-2.py-1",
            );
            if (originalUrlCode) {
                originalUrlCode.textContent = savedUrl;
            }

            // 更新 iframe 的 src
            const iframes = document.querySelectorAll("iframe");
            if (iframes.length >= 6) {
                iframes[0].src = urls.iframeQueryUrl;
                iframes[1].src = urls.iframePathUrl;
                iframes[2].src = urls.iframeHashUrl;
                iframes[3].src = urls.serverQueryUrl;
                iframes[4].src = urls.serverPathUrl;
                iframes[5].src = urls.serverHashUrl;
            }
        }
    });

    function generateUrls(inputUrl: string) {
        const encoded = encodeURIComponent(inputUrl);
        // 保存到 localStorage
        localStorage.setItem(STORAGE_KEY, inputUrl);
        return {
            iframeQueryUrl: `/projects/iframe/?url=${encoded}`,
            iframePathUrl: `/projects/iframe/${encoded}`,
            iframeHashUrl: `/projects/iframe/#${encoded}`,
            serverQueryUrl: `/projects/astro-server-proxy/?url=${encoded}`,
            serverPathUrl: `/projects/astro-server-proxy/${encoded}`,
            serverHashUrl: `/projects/astro-server-proxy/#${encoded}`,
        };
    }

    function updateGeneratedUrls(urls: Record<string, string>) {
        const container = document.getElementById("generated-urls");
        if (!container) return;

        // 创建 iframe 代理和服务器代理的分组
        const iframeGroup = document.createElement("div");
        iframeGroup.className = "mb-4";
        iframeGroup.innerHTML = `
            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">iframe 代理</h4>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24">Query 形式：</span>
                    <code class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1">${urls.iframeQueryUrl}</code>
                    <button class="copy-button px-2 py-1 text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400" data-url="${urls.iframeQueryUrl}">复制</button>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24">Path 形式：</span>
                    <code class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1">${urls.iframePathUrl}</code>
                    <button class="copy-button px-2 py-1 text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400" data-url="${urls.iframePathUrl}">复制</button>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24">Hash 形式：</span>
                    <code class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1">${urls.iframeHashUrl}</code>
                    <button class="copy-button px-2 py-1 text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400" data-url="${urls.iframeHashUrl}">复制</button>
                </div>
            </div>
        `;

        const serverGroup = document.createElement("div");
        serverGroup.innerHTML = `
            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">服务器代理</h4>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24">Query 形式：</span>
                    <code class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1">${urls.serverQueryUrl}</code>
                    <button class="copy-button px-2 py-1 text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400" data-url="${urls.serverQueryUrl}">复制</button>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24">Path 形式：</span>
                    <code class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1">${urls.serverPathUrl}</code>
                    <button class="copy-button px-2 py-1 text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400" data-url="${urls.serverPathUrl}">复制</button>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 w-24">Hash 形式：</span>
                    <code class="flex-1 text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1">${urls.serverHashUrl}</code>
                    <button class="copy-button px-2 py-1 text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400" data-url="${urls.serverHashUrl}">复制</button>
                </div>
            </div>
        `;

        // 清空容器并添加分组
        container.innerHTML = "";
        container.appendChild(iframeGroup);
        container.appendChild(serverGroup);
        container.classList.remove("hidden");

        // 添加复制按钮事件监听
        document.querySelectorAll(".copy-button").forEach((button) => {
            button.addEventListener("click", async (e) => {
                const url = (e.currentTarget as HTMLButtonElement).dataset.url;
                if (url) {
                    await navigator.clipboard.writeText(url);
                    (e.currentTarget as HTMLButtonElement).textContent =
                        "已复制！";
                    setTimeout(() => {
                        (e.currentTarget as HTMLButtonElement).textContent =
                            "复制";
                    }, 2000);
                }
            });
        });
    }

    // 生成 URL 按钮点击事件
    document.getElementById("generate-urls")?.addEventListener("click", () => {
        const input = document.getElementById("test-url") as HTMLInputElement;
        if (input.value) {
            const urls = generateUrls(input.value);
            updateGeneratedUrls(urls);

            // 更新 iframe 的 src
            const iframes = document.querySelectorAll("iframe");
            if (iframes.length >= 6) {
                iframes[0].src = urls.iframeQueryUrl;
                iframes[1].src = urls.iframePathUrl;
                iframes[2].src = urls.iframeHashUrl;
                iframes[3].src = urls.serverQueryUrl;
                iframes[4].src = urls.serverPathUrl;
                iframes[5].src = urls.serverHashUrl;
            }
        }
    });

    // 复制所有 URL 按钮点击事件
    document
        .getElementById("copy-urls")
        ?.addEventListener("click", async () => {
            const container = document.getElementById("generated-urls");
            if (!container) return;

            const urls = Array.from(container.querySelectorAll("code"))
                .map((code) => code.textContent)
                .filter(Boolean)
                .join("\n");

            if (urls) {
                await navigator.clipboard.writeText(urls);
                const button = document.getElementById("copy-urls");
                if (button) {
                    button.textContent = "已复制！";
                    setTimeout(() => {
                        button.textContent = "复制所有 URL";
                    }, 2000);
                }
            }
        });
</script>

<style>
    input[type="url"] {
        @apply dark:bg-gray-700 dark:border-gray-600 dark:text-white;
    }

    button {
        @apply disabled:opacity-50 disabled:cursor-not-allowed;
    }
</style>
